# 全体アーキテクチャ設計書

## 1. 概要

### 1.1 要望の背景

- 市販のExcel AIツールは有料が多く、個人開発者が気軽に試せない
- 自分のAPIキーを使って、無料でAI機能をExcelに統合したい
- 特定のLLMプロバイダーに縛られたくない

### 1.2 設計方針

**「サーバーレス・クライアント完結型」** を採用

```
┌─────────────────────────────────────────────────────────────────┐
│                        ユーザーのPC                              │
│  ┌─────────────┐    ┌─────────────────────────────────────────┐ │
│  │   Excel     │◄──►│  OpenLLM Add-in (ブラウザベース)         │ │
│  │             │    │  ┌─────────────────────────────────────┐ │ │
│  │  ┌───────┐  │    │  │ taskpane.js (メインロジック)        │ │ │
│  │  │セル   │  │    │  │ config.js (APIキー管理)             │ │ │
│  │  │データ │  │    │  └─────────────────────────────────────┘ │ │
│  │  └───────┘  │    └─────────────────────────────────────────┘ │
│  └─────────────┘                      │                          │
└───────────────────────────────────────┼──────────────────────────┘
                                        │ HTTPS (直接通信)
                    ┌───────────────────┼───────────────────┐
                    ▼                   ▼                   ▼
            ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
            │  OpenAI API │     │ Claude API  │     │ Gemini API  │
            └─────────────┘     └─────────────┘     └─────────────┘
```

### 1.3 なぜサーバーレスか

| 観点 | サーバーあり | サーバーレス（採用） |
|------|-------------|---------------------|
| 運用コスト | 月額費用発生 | 無料 |
| セットアップ | 複雑 | 簡単 |
| APIキー管理 | サーバー側で安全 | ユーザー責任 |
| スケーラビリティ | 管理必要 | 不要（各ユーザーが独立） |
| オープンソース親和性 | 低い | 高い |

**結論**: オープンソースプロジェクトとして、誰でもクローンして使えることを優先し、サーバーレスを選択。

## 2. ファイル構成

```
src/
├── taskpane/
│   ├── taskpane.html    # UI構造（HTMLテンプレート）
│   ├── taskpane.css     # スタイル定義
│   ├── taskpane.js      # メインロジック（約1000行）
│   └── config.js        # APIキー管理モジュール（約250行）
└── commands/
    ├── commands.html    # リボンコマンド用HTML
    └── commands.js      # リボンコマンドロジック
```

### 2.1 責務分離

| ファイル | 責務 | 依存関係 |
|---------|------|---------|
| `config.js` | APIキーの取得・保存・テスト | Office.js |
| `taskpane.js` | UI操作、LLM通信、Excel操作 | config.js, Office.js, Excel.js |

**なぜ分離したか**:
- APIキー管理は将来的に複雑化する可能性がある（OAuth対応など）
- テスト時にモック化しやすい
- 関心の分離（SRP: Single Responsibility Principle）

## 3. データフロー

### 3.1 チャット送信時のフロー

```
[ユーザー入力]
      │
      ▼
┌─────────────────┐
│ handleSendMessage() │
└─────────────────┘
      │
      ▼
┌─────────────────┐
│ getProviderAndModel() │  ← モデル選択から provider/model を抽出
└─────────────────┘
      │
      ▼
┌─────────────────┐
│ getApiKey(provider) │  ← 優先順位に従ってAPIキー取得
└─────────────────┘
      │
      ▼
┌─────────────────┐
│ sendToLLM()     │  ← プロバイダー別に分岐
└─────────────────┘
      │
      ├── sendToOpenAI()
      ├── sendToClaude()
      └── sendToGemini()
              │
              ▼
      [ストリーミングレスポンス]
              │
              ▼
      [UI更新（リアルタイム）]
```

### 3.2 状態管理

```javascript
// グローバル状態（taskpane.js）
let selectedCellAddress = "";     // 選択中のセルアドレス
let selectedCellValue = "";       // 選択中のセル値
let conversationHistory = [];     // 会話履歴（コンテキスト保持用）
let generatedExcelCode = "";      // 生成されたコード（実行待ち）
let uploadedFiles = [];           // アップロードされたファイル
```

**なぜグローバル変数か**:
- Office Add-inは単一ページアプリケーション
- 複雑な状態管理ライブラリ（Redux等）は過剰
- シンプルさを優先

## 4. 技術選定の根拠

### 4.1 Office Add-in (JavaScript)

**選定理由**:
- Microsoftが公式にサポートする唯一のExcel拡張方法
- VBAよりもモダンで、Web技術が使える
- クロスプラットフォーム（Windows, Mac, Web）

**代替案との比較**:
| 技術 | メリット | デメリット | 判断 |
|------|---------|-----------|------|
| VBA | 学習コスト低 | モダンAPIが使えない | ❌ |
| VSTO (C#) | 高パフォーマンス | Windows限定 | ❌ |
| Office Add-in | クロスプラットフォーム | Web制約あり | ✅ |

### 4.2 Webpack

**選定理由**:
- Office Add-in公式テンプレートで使用
- ES Modules、環境変数注入（DefinePlugin）に対応
- 成熟したエコシステム

**代替案との比較**:
| ツール | 判断理由 |
|--------|---------|
| Vite | Office Add-inテンプレートがない |
| Rollup | 同上 |
| Webpack | 公式サポート、実績あり ✅ |

### 4.3 Pure CSS（フレームワークなし）

**選定理由**:
- Office Add-inは表示領域が限定的（タスクペイン）
- 複雑なUIコンポーネントが不要
- バンドルサイズを最小化

**代替案との比較**:
| フレームワーク | 判断理由 |
|---------------|---------|
| Tailwind CSS | 設定が複雑、過剰 |
| Fluent UI | 公式だが学習コスト高 |
| Pure CSS | シンプル、十分 ✅ |

### 4.4 fetch API（ライブラリなし）

**選定理由**:
- ブラウザ標準API
- ストリーミングレスポンスに対応
- 依存関係ゼロ

**代替案との比較**:
| ライブラリ | 判断理由 |
|-----------|---------|
| axios | ストリーミング対応が弱い |
| openai SDK | OpenAI専用、他プロバイダー未対応 |
| fetch API | 標準、全プロバイダー対応 ✅ |

## 5. テスト戦略

### 5.1 テストの種類

| テスト種類 | 対象 | 方法 |
|-----------|------|------|
| 単体テスト | config.js の関数 | Jest（将来実装） |
| 統合テスト | LLM API通信 | 手動（APIキーテスト機能） |
| E2Eテスト | Excel上での動作 | 手動（サイドロード） |

### 5.2 現時点の検証方法

#### APIキー管理のテスト

| テストケース | 手順 | 期待結果 |
|-------------|------|---------|
| 環境変数読み込み | `.env.local`設定後、再起動 | ステータス「環境変数から読み込み」 |
| キー保存 | 入力 → 保存ボタン | ステータス「保存しました」 |
| キー復元 | ページリロード | 入力欄に自動復元 |
| キー削除 | 削除ボタン | 入力欄がクリア |
| 接続テスト（成功） | 有効なキー → テストボタン | ステータス「接続成功」 |
| 接続テスト（失敗） | 無効なキー → テストボタン | ステータス「接続失敗」 |

#### LLM通信のテスト

| テストケース | 手順 | 期待結果 |
|-------------|------|---------|
| OpenAI チャット | GPT-4o選択 → メッセージ送信 | ストリーミングで返答表示 |
| Claude チャット | Sonnet選択 → メッセージ送信 | ストリーミングで返答表示 |
| Gemini チャット | Flash選択 → メッセージ送信 | ストリーミングで返答表示 |
| 画像生成 | GPT Image 1選択 → 生成 | 画像が表示される |

## 6. 今後の拡張性

### 6.1 新プロバイダー追加

新しいLLMプロバイダーを追加する場合:

1. `taskpane.html` にモデル選択肢を追加
2. `config.js` にテスト関数を追加
3. `taskpane.js` に送信関数を追加
4. `getProviderAndModel()` でパース対応

### 6.2 認証方式の拡張

将来的にOAuth対応が必要な場合:

1. `config.js` に認証フローを追加
2. Office Dialog API でポップアップ認証
3. トークン管理の実装

## 7. 既知の制限事項

| 制限 | 原因 | 回避策 |
|------|------|--------|
| APIキーがブラウザに露出 | サーバーレス設計 | 本番環境ではプロキシサーバー推奨 |
| CORSエラー（Claude） | ブラウザ制約 | `anthropic-dangerous-direct-browser-access`ヘッダー |
| Office外での動作制限 | Office.js依存 | localStorage へのフォールバック |

